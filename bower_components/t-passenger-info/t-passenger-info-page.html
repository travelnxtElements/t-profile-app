<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="t-passenger-segment.html">
<link rel="import" href="t-communication.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-section-header/t-section-header.html" />
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../t-behavior/t-page-behavior.html">
<link rel="import" href="../t-behavior/t-session-behavior.html"/>

<!--
    <h3>Details:</h3>

        `t-passenger-info-page` is a passenger infor page component which displays & stores passenger information.

        It uses following child components in it -
            1. `t-frequent-flyer`
            2. `t-passenger-segment`
            3. `t-passport-info`
            4. `t-communication`
            5. `t-button`
            6. `t-sessionstorage`
            7. `t-section-header`

    <h3>Events:</h3>

        following events are fired by this component

            1. 'confirmation-error' - fired when error is occured while fetching booked itinerary from session, session is currently not used in this page.
            2. 'confirmation-success' - fired when confirmation page is loaded succesfully.
            3. `go-to-search` - fired when page is loaded without required page data.

    <h3>Example:</h3>

        <t-passenger-info-page
            id="passengerCount"
            name="paxInfo"
            hide-gender
            hide-date-of-birth
            hide-suffix
            hide-middle-name
            api-url-format="[[apiUrlFormat]]"
            passenger-info="{{passengerCount}}"
            on-passenger-save-success="_goToPaymentPage">
            <t-header
                icon="bgv:arrow-left"
                 url="[[siteUrl]]car/details"
                label="Guest Info"
                normal-heading>
            </t-header>
        </t-passenger-info-page>

    @demo demo/index.html
-->

<dom-module id="t-passenger-info-page">
    <template>
        <style>
            :host, t-button {
                display: block;
            }
            #savePassengers {
               margin: var(--normal-spacing,10px);
            }
            t-section-header {
                margin-bottom: 0;
            }
        </style>

        <t-notify type="error" id="notify"></t-notify>

        <!-- content tag to insert header component-->
        <content select=".t-header"></content>

        <!-- content tag to insert decorator component -->
        <content select=".decorator"></content>

        <div class="layout vertical">
            <template 
                id="list" 
                is="dom-repeat" 
                items="[[passengerDetails.passengerList]]" 
                as="passenger">

                    <t-section-header 
                        label="{{_getHeader(index, passenger.header)}}">
                    </t-section-header>

                    <t-passenger-segment
                        title="{{passenger.title}}"
                        first-name="{{passenger.firstName}}"
                        middle-name="{{passenger.middleName}}"
                        last-name="{{passenger.lastName}}"
                        type="{{passenger.type}}"
                        gender="{{passenger.genderString}}"
                        suffix="{{passenger.suffix}}"
                        date-of-birth="{{passenger.dob}}"                        
                        age="{{passenger.age}}"
                        hide-middle-name="{{_isHidden(passenger, 'middleName')}}"
                        hide-suffix="{{_isHidden(passenger, 'suffix')}}"
                        hide-title="{{_isHidden(passenger, 'title')}}"
                        hide-date-of-birth="{{_isHidden(passenger, 'dob')}}"
                        hide-age="{{_isHidden(passenger, 'age')}}"
                        hide-gender="[[hideGender]]"
                        min-age="[[passenger.minAge]]"
                        max-age="[[passenger.maxAge]]"
                        departure-date="[[departureDate]]">
                    </t-passenger-segment>
            </template>            
        </div>

        <t-communication
            phone="{{passengerDetails.phone}}" 
            email="{{passengerDetails.email}}">                
        </t-communication>

        <t-button 
            id="savePassengers"
            class="primary row" 
            on-tap="_savePassengerData" 
            type="button" 
            label="continue">               
        </t-button>

        <iron-ajax 
            id="countryCall" 
            url="[[countryApi]]" 
            method="GET" 
            verbose 
            headers='{"accept": "application/json"}' 
            handle-as="json" 
            content-type="application/json" 
            last-response="{{countries}}">                
        </iron-ajax>

        <t-sessionstorage
            id="sessionStore"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-load-success="_onSessionGet"
            on-t-sessionstorage-save-success="_onSessionSave">
        </t-sessionstorage>
    </template>

    <script>

        (function () {

            'use strict'
            Polymer({

                is: 't-passenger-info-page',

                behaviors: [
                    TravelNxt.Behaviors.PageBehavior,
                    TravelNxt.Behaviors.SessionBehavior
                ],

                properties: {

                    /**
                     * This stores the passenger details information with contact details
                     * @type {Object}
                     */
                    _paxDetails: {
                        type: Object,
                        readOnly: true
                    },

                    /**
                     * This stores the passenger details information with contact details
                     * @type {Object}
                     */
                    passengerDetails: {
                        type: Object,
                        notify: true
                    },

                    /*
                     * <p>This object holds info of number and type of passengers to be rendered</p>
                     * <p>It overrides behavior property</p>
                    */
                    passengerCount: {
                        type: Object,
                        observer: '__updatePaxCountInSession'
                    },

                    /*
                     * <p>This property sets the title for primary passenger</p>
                    */
                    primaryHeader: {
                        type: String,
                        value:'Adult 1'
                    },

                    /*
                     * <p>This property hides the gender information in passenegr segment</p>
                    */
                    hideGender : {
                        type: Boolean                        
                    },

                    /**
                     * This date is used as a reference to restrict ages in calender.
                     * The age ranged will be determined by `ageMappings` property.                     
                     */
                    departureDate: {
                        type: Date
                    },

                    /**
                     * This is the value for session key.
                     */
                    sessionKey: {
                        type: String,
                        value: ''
                    }
                },

                listeners: {
                    'session-get-complete': '_updatePage',
                    'session-set-complete': '_redirect'
                },

                observers: [
                    '__pageLoad(visible)'
                ],
                
                __pageLoad: function (visible) {

                    if (!visible) {
                        return;
                    }

                    this._syncSession();
                },

                __updatePaxCountInSession : function (passengerCount) {

                    if (!passengerCount) {
                        return;
                    }

                    this._data = [{
                        key: this.sessionKey + '_Passenger_Count',
                        value: passengerCount
                    }];

                    this.setSession();                    
                },

                /*
                 * <p>This is the success event handler for `t-sessionstorage` save event</p>
                */
                _updatePage: function () {
                    this._updatePassengerDetails();                                    
                },

                _syncSession: function () {
                    this._data = [{
                        key: this.sessionKey + '_Passenger_Details',
                        propertyName: 'passengerDetails'
                    }, {
                        key: this.sessionKey + '_Passenger_Count',
                        propertyName: 'passengerCount'
                    }];

                    this.getSession();
                },

                /*
                 * <p>This methods updates the passenger list as per the current data stored in `passengerCount` & `sessionStore`</p>
                */
                _updatePassengerDetails: function () {
                    var sessionPassengers = this.passengerDetails;

                    var paxInfo = {
                        email: '',
                        phone: '',
                        passengerList: []
                    }

                    if (sessionPassengers && sessionPassengers.passengerList) {
                        var sessionPaxTypes = this._getPassengerTypes(sessionPassengers.passengerList);
                        var paxTypes = this._getPassengerTypes(this.passengerCount.passengerList);
                        this._pushPassengers(paxInfo.passengerList, sessionPaxTypes, paxTypes);
                        paxInfo.email = sessionPassengers.email;
                        paxInfo.phone = sessionPassengers.phone;
                    } else {
                        paxInfo.passengerList = this.passengerCount.passengerList;
                    }

                    this.passengerDetails= {};

                    // Time out required to set dropdowns of age and title correctly
                    setTimeout(function () {
                        this.passengerDetails = paxInfo;
                    }.bind(this), 100)
                },

                /**
                 * This method push the passengers in given list in arguments
                 * @param  {Array} newList     List to be modified
                 * @param  {Array} sessionList List of passengers from session
                 * @param  {Array} currentList List of current passengers required for inventory
                 * @return {Void}
                 */
                _pushPassengers: function (newList, sessionList, currentList) {
                    if (!currentList) {
                        return;
                    }

                    Object.keys(currentList).forEach(function (paxType) {
                        for (var i = 0; i < currentList[paxType].length; i++) {
                            if (sessionList[paxType] && sessionList[paxType][i]) {

                                if (sessionList[paxType][i].age < currentList[paxType][i].minAge && sessionList[paxType][i].age > currentList[paxType][i].maxAge){
                                    sessionList[paxType][i].age = null;
                                }

                                sessionList[paxType][i].maxAge = currentList[paxType][i].maxAge;
                                sessionList[paxType][i].minAge = currentList[paxType][i].minAge;
                                newList.push(sessionList[paxType][i]);
                            } else {
                                newList.push(currentList[paxType][i]);
                            }
                        }
                    });
                },

                /**
                 * This method returns an object having types of passengers and along with passenger list of that type
                 * @param  {Array} paxList Passenger list
                 * @return {Object}
                 */
                _getPassengerTypes: function (paxList) {
                    if (!paxList || !paxList.length) {
                        return null;
                    }

                    var paxTypes = {};
                    paxList.forEach(function (pax) {
                        if (!paxTypes[pax.type.toLowerCase()]) {
                            paxTypes[pax.type.toLowerCase()] = [];
                        }
                        paxTypes[pax.type.toLowerCase()].push(pax);
                    });
                    return paxTypes;
                },

                /*
                 * <p>Event handler called on save button click</p>
                */
                _savePassengerData: function () {
                    if (this.validate()) {
                        this._data = [{
                            key: this.sessionKey + '_Passenger_Details',
                            value: this.passengerDetails
                        }];

                        this.setSession();
                    }
                },

                _redirect: function () {
                    if (this.$.sessionStore.key === this.sessionKey +  '_Passenger_Details') {
                        this.fire('passenger-save-success');
                    }
                },

                /*
                 * <p>Checks if property in passenger segment needs to be kept hidden</p>
                */
                _isHidden: function (passenger, property) {
                    return passenger[property] === undefined;
                },

                /*
                 * <p>Overrides the default header value by the one specified in `primaryHeader`</p>
                */
                _getHeader: function (index, header) {
                    return index === 0 && this.primaryHeader ? this.primaryHeader : header;
                },

                /*
                 * <p>Validates passenger information</p>
                */
                validate: function () {
                    if (this.$.savePassengers.disabled) {
                        return;
                    }
                    var isValid = true;
                    var paxSegments = this.querySelectorAll('t-passenger-segment');
                    for (var i = 0; i < paxSegments.length; i++) {                        
                        isValid = paxSegments[i].validate() && isValid;
                    }
                    isValid = this.querySelector('t-communication').validate() && isValid;
                    return isValid;
                }
            });

        })();
    </script>
</dom-module>
