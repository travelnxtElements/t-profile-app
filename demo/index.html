<!doctype html>
<html>

<head>
    <title>t-profile-app demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="../../t-shared-components/theme.html">
    <link rel="import" href="../../t-mystique-auth/t-mystique-auth.html">
    <link rel="import" href="../../iron-ajax/iron-ajax.html">
    <link rel="import" href="../../t-sign-in/t-sign-in.html">
    <link rel="import" href="../../t-passenger-info/t-communication.html">
    <link rel="import" href="../../t-passenger-info/t-passenger-segment.html">
    <link rel="import" href="../../t-sign-in/t-sign-in-api.html">
    <style>
    body {
        margin: 0;
        padding: 0;
    }
    </style>
    <link rel="import" href="../t-profile-app.html">
</head>

<body>
    <template is="dom-bind" id="app">
        <app-location use-hash-as-path route="{{route}}"></app-location>
        <app-route route="{{route}}">
        </app-route>
        <t-mystique-auth name="mystiquedemo" url="[[apiBaseUrl]]api/authentication/authenticate/context" token-response="{{tokenResponse}}" auto>
        </t-mystique-auth>
        <t-sign-in id="loginView" username="{{userName}}" hidden$="[[signedIn]]"></t-sign-in>
        <t-sign-in-api id="loginApi" loading={{loading}} api-base-url="[[apiBaseUrl]]" api-relative-url="api/authentication/authenticate/user" auth-token="{{tokenResponse.authenticationToken}}"></t-sign-in-api>
      
        <iron-ajax id="ajax" url="{{apiBaseUrl}}api/User/get/username/[[userName]]?token={{tokenResponse.authenticationToken}}" handle-as="json" on-response="handleResponse"></iron-ajax>
        <iron-ajax id="updateAjax" url="{{apiBaseUrl}}api/User/get/[[userId]]?token={{tokenResponse.authenticationToken}}" handle-as="json" on-response="_setProfileData"></iron-ajax>

        <template is="dom-if" if="[[signedIn]]">
            <t-profile-app navigation-data="[[navigationData]]" profile-info="[[profileInfo]]" list-formats="[[listFormats]]" info-formats="[[infoFormats]]" visible route="[[route]]" site-url="#/"></t-profile-app>
        </template>
    </template>
</body>
<script>
app.signedIn = false;
app.apiBaseUrl = "http://demo.travelnxt.com/";

window.addEventListener('WebComponentsReady', function(e) {
    var app = document.querySelector('#app');
    var loginView = document.querySelector('#loginView');
    var loginApi = document.querySelector('#loginApi');

    loginView.addEventListener('t-sign-in-authenticate', loginApi.onAuthenticate.bind(loginApi));

    loginApi.addEventListener('t-sign-in-api-success', function(e) {
        loginView.onAuthenticateSuccess.bind(loginView);
        app.signedIn = true;
        app.$.ajax.generateRequest();
    });
    loginApi.addEventListener('t-sign-in-api-error', loginView.onAuthenticateError.bind(loginView));

    //this is based on all the possible list routes
    app.listFormats = {
        "fellowTravellers": {
            "header": "Travelers List",
            "format": ["personalDetails.name.title", "personalDetails.name.firstName", "personalDetails.name.lastName"]
        },
        "memberships": {
            "header": "Memberships",
            "format": ["productType","providerName","providerCode"]
        },
        "addresses": {
            "header": "Address List",
            "format": ["addressLine1", "addressLine2","city","state", "country"]
        }
    };
    //this is based on all the possible info routes
    app.infoFormats = {
        "fellowTravellers":{
            "header":"Passenger",
            "component":"t-passenger-segment",
            "setProperties":{
                "title":{"key":"personalDetails.name.title"},
                "firstName":{"key":"personalDetails.name.firstName"},
                "middleName":{"key":"personalDetails.name.middleName"},
                "lastName":{"key":"personalDetails.name.lastName"},
                "suffix":{"key":"personalDetails.name.suffix"},
                "hideGender":{"value":true},
                "dateOfBirth": {"key":"personalDetails.dateOfBirth.date"}
            },
            "getProperties":["title","firstName","lastName","suffix","dateOfBirth","gender"],
            "isValid":{
                "type":"method",
                "name": "validate",
                "value": true
            }
        },
        "contacts": {
            "header": "Communication",
            "component": "t-communication",
            "setProperties":{
                "hideSectionHeader":{"value":true},
                "email":{"key":"emails.0.value"},
                "phone":{"key":"phones.0.value"}
            },
            "getProperties":["email","phone"],
            "isValid":{
                "type": "property",
                "name": "invalid",
                "value":false
            }
        },
        "basicInfo":{
            "header":"Personal Info",
            "component":"t-passenger-segment",
            "setProperties":{
                "title":{"key":"name.title"},
                "type":{"value":"all"},
                "firstName":{"key":"name.firstName"},
                "middleName":{"key":"name.middleName"},
                "lastName":{"key":"name.lastName"},
                "suffix":{"key":"name.suffix"},
                "hideGender":{"value":true},
                "dateOfBirth": {"key":"dateOfBirth.date"}
            },
            "getProperties":["title","firstName","lastName","suffix","dateOfBirth","gender"]
        }
    };

    app.navigationData = [{
        "name": "Personal Info",
        "type": "info",
        "category": "basicInfo"
    }, {
        "name": "Communication Details",
        "type": "info",
        "category": "contacts"
    }, {
        "name": "Passenger List/Other Travelers",
        "type": "list",
        "category": "fellowTravellers"
    }, {
        "name": "Flight Membership",
        "type": "list",
        "category": "memberships"
    }, {
        "name": "Address",
        "type": "list",
        "category": "addresses"
    }, {
        "name": "Change Password",
        "type": "info",
        "category": "password"
    }];
    app.handleResponse = function(e) {
        app.userId = e.detail.response.result.id;
        app.$.updateAjax.generateRequest();
    };

    app._setProfileData = function(e){
        app.profileInfo = e.detail.response.result;
    };


});
</script>

</html>
